name: build java project with maven 

on: 
    push:
      branches:
        - main
    workflow_dispatch:    
 ### the above trigger causes the workflow to be triggered when code is poushed to main. 

jobs:

    Build-test-deploy: ### this specifies the job name 
        runs-on: ubuntu-latest ### this specifies where the job should run
        steps:
            - name: clone repository
              uses: actions/checkout@v3  ### the first step clones our repo into the runner. 

            - name: install and setup java with maven 
              uses: actions/setup-java@v3
              with:
                distribution: 'adopt'
                java-version: '11' 
            - name: code build with maven 
              run:  mvn package   

            - name: upload mvn artifact
              uses: actions/upload-artifact@v3
              with:
                name: webapp
                path: target/*.war
    deploy_artifact:
        runs-on: ubuntu-latest
        needs: Build-test-deploy
        steps:
          - name: clone repository
            uses: actions/checkout@v3  ### the first step clones our repo into the runner. 

          - name: install and setup java with maven 
            uses: actions/setup-java@v3
            with:
              distribution: 'adopt'
              java-version: '11'
          - name: artifact download
            uses: actions/download-artifact@v3
            with:
              name: webapp
              path: ~/
          - name: tomcat aspect
            run: |
              echo "${{ secrets.JIBOLAKP }}" >> /home/runner/key.pem
              chmod 400 /home/runner/key.pem
              echo /home/runner/key.pem
          - name: push to tomcat server
            run: scp -i /home/runner/key.pem /home/runner/webapp ${{ secrets.TOMCAT_SERVER }}:/opt/tomcat9/webapps





